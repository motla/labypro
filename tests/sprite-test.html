<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
</head>
<style>
    :root {
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
      height: 100%;
    }
    * {
      user-select: none;
      -webkit-user-select: none;
    }
</style>
<body>
  <div id="test"></div>
  <canvas id="grid" style="position: fixed; top: 0; left: 50%; margin-left: -17px; transform: translate(0, 0);"></canvas>
  <div id="sprite" style="position: fixed; top: 100px; left: 50%; margin-left: -17px; width: 35px; height: 35px; background-image: url(../images/sprites/john.png); background-size: cover; background-repeat: no-repeat; transform: scale(1);"></div>
  <svg id="joystick" width="150" height="150" style="position: fixed; right: 10px; bottom: 10px">
    <circle cx="50%" cy="50%" r="50" stroke="rgba(0,0,0,0.3)" stroke-width="40" fill="none"></circle>
    <polygon points="75,15 60,50 90,50" fill="rgba(0,0,0,0.6)" />
    <polygon points="75,135 60,100 90,100" fill="rgba(0,0,0,0.6)" />
    <polygon points="15,75 50,60 50,90" fill="rgba(0,0,0,0.6)" />
    <polygon points="135,75 100,60 100,90" fill="rgba(0,0,0,0.6)" />
  </svg>
  <script>
    const level = [20,20,null,null,null,null,null,null,null,null,null,true,null,null,null,null,null,null,null,null,null,null,true,null,true,true,null,true,null,true,null,null,true,true,true,true,true,true,true,true,null,null,true,true,true,true,true,true,true,true,true,null,true,null,null,null,true,null,null,null,null,true,null,null,null,true,null,null,null,true,true,true,true,true,true,true,true,true,true,null,true,null,true,null,null,null,null,true,null,true,null,true,null,null,true,null,true,null,true,null,true,true,true,null,true,true,true,null,true,null,true,null,true,null,null,true,null,null,null,null,null,null,true,null,true,null,null,null,null,null,null,true,null,true,true,true,true,true,null,true,true,true,true,true,null,null,true,null,true,true,true,true,null,null,null,null,null,null,true,null,null,null,null,true,true,true,true,true,null,null,null,null,true,null,true,true,true,null,true,true,true,true,true,true,null,null,null,null,true,true,true,true,true,true,null,null,null,null,null,null,null,true,true,true,true,true,true,null,true,null,null,true,null,true,true,true,null,true,true,true,true,true,null,null,null,true,null,true,true,true,true,null,true,null,null,null,true,null,null,null,null,null,null,true,null,null,null,true,null,null,null,null,true,true,true,null,true,true,true,true,true,true,true,true,true,true,null,null,true,true,true,null,null,null,null,null,null,null,null,null,null,null,null,null,null,true,true,true,null,null,true,true,true,true,null,true,true,true,true,true,true,true,true,true,true,null,null,null,true,null,null,null,null,null,true,null,null,null,null,null,null,null,null,null,null,true,true,true,null,true,true,true,true,null,null,true,null,true,null,true,true,true,true,true,true,null,null,true,true,null,null,null,null,true,true,null,true,true,true,null,null,null,null,null,true,true,null,null,null,true,true,null,null,true,true,true,null,null,null,true,true,true,true,null,null,true,true,true,true,true,null,null,null,null,null,true,null,true,true,null,null,null,true,true,null,null,null,null,null,null,true,null,true,true,true,true,null,null,null,true,true,true,null,null,true,true,null,true,null,true,null,null,true,null,true,null,true,true,null,null,null,true,true,null,true,true,true,true,true,true,null,true,true,true,true,null,null,null,true,true,true,true,true,true,null,true,null,true,null,null,true,null,null,null,null,true,null,null,null,null,null,true,null,null,null,null,null,null,null,null,null,null,null,true,null,null,true,true,true,true,null,null,null,true,true,null,null,null,null,true,true,true,true,null,true,null,null,true,null,true,null,true,true,null,true,true,true,true,null,null,null,true,true,null,null,true,null,null,null,true,null,true,true,null,true,null,null,null,true,true,true,null,null,true,true,null,true,true,null,true,true,null,null,null,null,true,true,null,null,null,null,true,null,null,true,true,null,true,null,true,true,true,true,null,true,true,null,true,true,true,true,true,true,true,null,true,true,true,null,null,null,null,null,null,null,true,null,null,null,null,null,null,null,null,null,true,null,null,true,null,null,true,true,null,true,null,true,null,true,true,true,true,true,true,true,null,true,true,true,true,null,null,null,null,true,null,null,null,true,null,null,null,null,null,null,true,null,null,null,true,true,true,true,null,null,true,true,null,null,true,true,true,true,true,true,null,null,true,true,null,null,null,true,true,null,null,true,true,null,null,null,true,null,null,true,true,true,true,null,true,true,true,null,null,true,null,true,true,true,true,null,null,null,null,null,null,null,null,null,null,null,null,true,null,true,null,null,true,null,true,true,true,true,true,true,true,true,true,true,true,true,true,null,null,null,null,null,null,null,null,null,null,null,true,null,null,null,null,null,null,null,null];
    const grid_size = 30;
    const border_size = 4;
    const margin = 5;

    const sprite = document.getElementById("sprite");
    const grid = document.getElementById("grid");
    const joystick = document.getElementById("joystick");
    const test = document.getElementById("test");
    let currentSpriteFrame = 0;
    let currentDirection = "idle";
    let wantedDirection = "idle";
    const grid_pos = [0, 0];

    // Sprite X positions for each state
    const states = {
      idle: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 35],
      left: [70, 70, 105, 105],
      right: [140, 140, 175, 175],
      up: [210, 210, 245, 245],
      down: [280, 280, 315, 315]
    };

    function updateSprite() {
      currentSpriteFrame = (currentSpriteFrame + 1) % states[currentDirection].length;
      const x = states[currentDirection][currentSpriteFrame];
      sprite.style.backgroundPosition = `-${x}px 0`;
    }
    setInterval(updateSprite, 70);

    function updateGridPosition() {
      const x_pos = (grid_size/2-(grid_pos[0]+margin-border_size/2));
      const y_pos = (100+grid_size-(grid_pos[1]+margin-border_size/2));
      const i = Math.floor(x_pos/grid_size);
      const j = Math.floor(y_pos/grid_size);
      const a = 2 + (level[0]*2 - 1) * j + i;
      const b = 1 + (level[0]*2 - 1) * j + i + level[0];
      const c = 2 + (level[0]*2 - 1) * (j + 1) + i;
      const d = 1 + (level[0]*2 - 1) * j + (i + 1) + level[0];
      test.innerText = `i=${i}/j=${j} (a=${a}/b=${b}/c=${c}/d=${d})`;
      if(wantedDirection == "left") {
        if(-grid_pos[0] > margin) { // interdire de sortir du labyrinthe par la gauche
          if((x_pos % grid_size) > 10 || level[b]) { // interdire de franchir le mur de gauche
            currentDirection = "left";
            grid_pos[0] += 2;
          }
        } else currentDirection = "idle";
      }
      else if(wantedDirection == "right") {
        if(-grid_pos[0] < (level[0] - 2)*grid_size + margin) { // interdire de sortir du labyrinthe par la droite
          if((x_pos % grid_size) < (grid_size - 10) || level[d]) { // interdire de franchir le mur de droite
            currentDirection = "right";
            grid_pos[0] -= 2;
          }
        } else currentDirection = "idle";
      }
      else if(wantedDirection == "up") {
        if(grid_pos[1] < 110) { // interdire de sortir du labyrinthe par le haut
          if((y_pos % grid_size) > 10 || level[a]) { // interdire de franchir le mur du haut
            currentDirection = "up";
            grid_pos[1] += 2;
          }
        } else currentDirection = "idle";
      }
      else if(wantedDirection == "down") {
        if((y_pos % grid_size) < (grid_size - 5) || level[c]) { // interdire de franchir le mur du bas
          currentDirection = "down";
          grid_pos[1] -= 2;
        }
      }
      else currentDirection = "idle";
      grid.style.transform = "translate(" + grid_pos[0] + "px, " + grid_pos[1] + "px)";
    }
    setInterval(updateGridPosition, 20);

    function draw_level () {
      const largeur = level[0];
      const hauteur = level[1];
      const ctx = grid.getContext("2d");
      grid.width = grid_size * (largeur - 1) + 2*margin;
      grid.height = grid_size * (hauteur - 1) + 2*margin;
      ctx.clearRect(0, 0, grid.width, grid.height);
      ctx.strokeStyle = "black";
      ctx.textBaseline = "middle";
      ctx.textAlign = "center";
      ctx.font = "12px sans-serif";
      //ctx.lineWidth = taille_bordure;
      for(let i = 0; i < largeur; i++) {
        for(let j = 0; j < hauteur; j++) {
          let x = i*grid_size + margin;
          let y = j*grid_size + margin;
          // barre horizontale
          if(i < largeur - 1) {
            const a = 2 + (largeur*2 - 1) * j + i;
            if(!level[a]) {
              ctx.beginPath();
              ctx.moveTo(x, y);
              ctx.lineTo(x + grid_size, y);
              ctx.stroke();
              ctx.fillStyle = "red";
              ctx.fillText(a, x + grid_size/2, y);
            }
          }
          // barre verticale
          if(j < hauteur - 1) {
            const b = 1 + (largeur*2 - 1) * j + i + largeur;
            if(!level[b]) {
              ctx.beginPath();
              ctx.moveTo(x, y);
              ctx.lineTo(x, y + grid_size);
              ctx.stroke();
              ctx.fillStyle = "blue";
              ctx.fillText(b, x, y + grid_size/2);
            }
          }
        }
      }
    }
    draw_level();

    function setInitialGridPos () {
      // find the index of the first door
      const index = level.findIndex(val => val === true);
      grid_pos[0] = -(index - 2) * grid_size - margin + border_size/2;
      grid_pos[1] = 100;
      updateGridPosition();
    }
    setInitialGridPos();
    
    // Key handling
    document.addEventListener("keydown", (e) => {
      if (e.repeat) return;
      if (e.key === "ArrowLeft") wantedDirection = "left";
      else if (e.key === "ArrowRight") wantedDirection = "right";
      else if (e.key === "ArrowUp") wantedDirection = "up";
      else if (e.key === "ArrowDown") wantedDirection = "down";
    });
    document.addEventListener("keyup", (e) => { wantedDirection = "idle"; });

    // Joystick handling
    function joystick_handler(e) {
      let x, y;
      const rect = joystick.getBoundingClientRect();
      if (e.touches && e.touches.length > 0) {
        x = e.touches[0].clientX - rect.left;
        y = e.touches[0].clientY - rect.top;
      } else {
        x = e.offsetX;
        y = e.offsetY;
      }
      const width = joystick.width.baseVal.value;
      const is_diag_top_left = x < y;
      const is_diag_top_right = (width - x) < y;
      if (is_diag_top_left) {
        if (is_diag_top_right) wantedDirection = "down";
        else wantedDirection = "left";
      } else {
        if (is_diag_top_right) wantedDirection = "right";
        else wantedDirection = "up";
      }
    }

    joystick.addEventListener("touchstart", joystick_handler);
    joystick.addEventListener("touchmove", joystick_handler);
    joystick.addEventListener("mousedown", joystick_handler); // Optional: support mouse too
    document.addEventListener("mouseup", (e) => { wantedDirection = "idle"; });
  </script>
</body>
</html>